---
title: "Chiles-q"
author: "Kyle MacDonald"
date: "2/20/2017"
output: html_document
---

## Set up

```{r}
library(magrittr)
library(stringr)
library(tidyverse)
library(RMySQL)
library(directlabels)
theme_set(ggthemes::theme_few())
```

Connect to the childes db

```{r}
con <- dbConnect(RMySQL::MySQL(), user='root', password='mbrllngs12', dbname='childes')
```

List the tables in the db

```{r}
dbListTables(con)
```

Get the data from the db

```{r}
# metadata
corpora_meta_data <- dbReadTable(con, "corpora")
kid_meta_data <- dbReadTable(con, "children")

# production freq data
word_freq_long <- dbReadTable(con, "childes_chi_long_freq")
```

Just get the brown corpus from words

```{r}
all_questions <- dbGetQuery(con, "SELECT * FROM words WHERE gloss LIKE '%WHY%' OR gloss LIKE '%WHAT%' OR gloss LIKE '%WHERE%'")
```

## Descriptives

```{r}
all_questions %>% 
  distinct(corpus) %>% 
  knitr::kable()
```

```{r}
all_questions %>% 
  distinct(child) %>% 
  nrow() %>% 
  paste("n children =", .)
```


## Exploratory analyses

Change in frequence of different question words across development

```{r}
word_freq_long %>% 
  filter(word %in% c("why", "what", "when", "how", "where"),
         age <= 30) %>% 
  ggplot(data = ., aes(x = age, y = frequency, color = word)) +
  langcog::scale_color_solarized() +
  guides(color=F) +
  geom_line(size = 1) +
  geom_dl(aes(label = word), method=list("last.points")) +
  xlim(12, 32) 
```

Get just kids questions

```{r}
kids_questions <- all_questions %>% 
  filter(speaker == "CHI")
```

Clean up data 

```{r}
days_in_month <- 30.436875

kids_questions %<>% 
  select(gloss,speaker, mor, participants, gender, age, child, corpus, sentgloss) %>% 
  mutate(age_months = round(age / days_in_month, 0),
         child_clean = ifelse(child == "--", corpus, child))
```

```{r}
kids_questions %<>% 
  mutate(gloss_clean = ifelse(str_detect(gloss, "why"), "why", 
                              ifelse(str_detect(gloss, "what"), "what", 
                                     "where")))
```


Count different kinds of questions for each kid and plot as a function of age.

```{r}
kids_questions %>% 
  group_by(child_clean, age_months, gloss_clean) %>% 
  summarise(freq = n()) %>% 
  filter(freq > 0) %>% 
  ggplot(., aes(x = age_months, y = freq, color = gloss_clean)) +
  geom_line(size = 1) +
  langcog::scale_color_solarized() +
  facet_wrap(~child_clean)
```

Now get the average frequency for each question type at each month of development.

```{r}
kids_questions %>% 
  group_by(child_clean, age_months, gloss_clean) %>% 
  summarise(freq = n()) %>% 
  filter(freq > 0) %>% 
  group_by(age_months, gloss_clean) %>% 
  summarise(m = mean(freq, na.rm = T),
            n = n()) %>% 
  ggplot(., aes(x = age_months, y = m, color = gloss_clean)) +
  geom_point(aes(size = n), alpha = 0.7) +
  geom_smooth(se=F, method = "loess", size = 2) +
  #geom_line(size = 1) +
  xlim(10, 65) +
  guides(color = F) +
  langcog::scale_color_solarized() +
  geom_dl(aes(label = gloss_clean), method=list("last.points")) 
```

### Context analyses

Spread participants variable, so we can code for the number of people in the conversation.

```{r}

```