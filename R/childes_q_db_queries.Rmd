---
title: "Childes-q"
author: "Kyle MacDonald"
date: "2/20/2017"
output: html_document
---

## Set up

```{r}
rm(list=ls())
library(magrittr)
library(stringr)
library(knitr)
library(tidyverse)
library(RMySQL)
library(directlabels)
theme_set(ggthemes::theme_few())
```

## Connect to the CHILDES db 

Code adapted from the `dplyr` databases [vignette](https://cran.r-project.org/web/packages/dplyr/vignettes/databases.html)

Note that prior to running this code, you need to make sure that the mysql server is running. In the terminal, run: `mysql.server start`

```{r}
db <- src_mysql(host = "localhost", user='root', password='mbrllngs12', dbname='childes')
```

Get the relevant tables from the database

```{r}
corpora_meta_data <- tbl(db, "corpora")
kid_meta_data <- tbl(db, "children")
words <- tbl(db, "words")
```

## Extract all utterances with question words

```{r}
# start the clock
ptm <- proc.time()

all_qs <- words %>% 
  filter(gloss %in% c("why", "what", "where", "when", "which", "how", "who", "whose", "whom" )) %>% 
  collect(n = Inf) 

# Stop the clock
proc.time() - ptm
```

Clean up the data 

```{r}
days_in_month <- 30.436875

all_questions <- all_qs %>% 
  select(gloss,speaker, mor, participants, gender, age, child, corpus, 
         sentgloss, utt_number) %>% 
  filter(speaker %in% c("MOT", "CHI", "DAD", "FAT")) %>% 
  mutate(age_months = round(age / days_in_month, 0),
         child_clean = ifelse(child == "--", corpus, child),
         speaker_clean = ifelse(speaker == "CHI", "child", "parent"),
         parent_type = ifelse(speaker == "MOT", "mother", "father"))
```

```{r}
all_questions %<>% 
  mutate(gloss_clean = ifelse(str_detect(gloss, "why"), "why", 
                              ifelse(str_detect(gloss, "what"), "what",
                                     ifelse(str_detect(gloss, "where"), "where",
                                            ifelse(str_detect(gloss, "who"), "who",
                                                   ifelse(str_detect(gloss, "how"), "how",
                                                          ifelse(str_detect(gloss, "when"), "when",
                                                                 ifelse(str_detect(gloss, "which"), "which",
                                                                        ifelse(str_detect(gloss, "whose"), "whose",
                                                                               ifelse(str_detect(gloss, "whom"), "whom",
                                                                               "other"))))))))),
         utt_number = as.numeric(utt_number))
```

Get max utterance number for each recording, so we can normalize. 

```{r}
tmp <- all_questions %>% 
  group_by(child_clean, age_months) %>% 
  mutate(utt_number = as.numeric(utt_number)) %>% 
  summarise(length_transcript = max(utt_number))

all_questions %<>% left_join(., tmp, by = c("child_clean", "age_months"))
```

Save as csv

```{r, eval = F}
write_csv(x = all_questions, "../data/childes_questions.csv")
```
